/*!
 *@name     jquery.barrager.min.js
 *@project  jquery.barrager.js
 *@author   yaseng@uauc.net
 *@project  https:/*github.com/yaseng/jquery.barrager.js
 */
!(function (a) {
  ;(a.fn.barrager = function (b) {
    function m() {
      var b = a(window).width() + 500
      return b > k
        ? ((k += 1), a(e).css('margin-right', k), void 0)
        : (a(e).remove(), !1)
    }
    var c, d, e, f, g, h, i, j, k, l
    ;(b = a.extend(
      {
        close: !0,
        bottom: 0,
        max: 10,
        speed: 6,
        color: '#fff',
        old_ie_color: '#FFFFFF',
      },
      b || {}
    )),
      (c = new Date().getTime()),
      (d = 'barrage_' + c),
      (e = '#' + d),
      (f = a("<div class='barrage' id='" + d + "'></div>").appendTo(a(this))),
      (g = a(window).height() - 100),
      (h = 0 == b.bottom ? Math.floor(Math.random() * g + 40) : b.bottom),
      f.css('bottom', h + 'px'),
      (div_barrager_box = a("<div class='barrage_box cl'></div>").appendTo(f)),
      b.img &&
        (div_barrager_box.append(
          "<a class='portrait z' href='javascript:;'></a>"
        ),
        (i = a("<img src='' >").appendTo(e + ' .barrage_box .portrait')),
        i.attr('src', b.img)),
      div_barrager_box.append(" <div class='z p'></div>"),
      b.close && div_barrager_box.append(" <div class='close z'></div>"),
      (j = a("<a title='' href=''></a>").appendTo(e + ' .barrage_box .p')),
      j.attr({ href: b.href, id: b.id }).empty().append(b.info),
      navigator.userAgent.indexOf('MSIE 6.0') > 0 ||
      navigator.userAgent.indexOf('MSIE 7.0') > 0 ||
      navigator.userAgent.indexOf('MSIE 8.0') > 0
        ? j.css('color', b.old_ie_color)
        : j.css('color', b.color),
      (k = 0),
      f.css('margin-right', k),
      (l = setInterval(m, b.speed)),
      div_barrager_box.mouseover(function () {
        clearInterval(l)
      }),
      div_barrager_box.mouseout(function () {
        l = setInterval(m, b.speed)
      }),
      a(e + '.barrage .barrage_box .close').click(function () {
        a(e).remove()
      })
  }),
    (a.fn.barrager.removeAll = function () {
      a('.barrage').remove()
    })
})(jQuery)

function isIE() {
  if (!!window.ActiveXObject || 'ActiveXObject' in window) return true
  else return false
}
if (!isIE()) {
  var hidden, state, visibilityChange
  if (typeof document.hidden !== 'undefined') {
    hidden = 'hidden'
    visibilityChange = 'visibilitychange'
    state = 'visibilityState'
  } else if (typeof document.mozHidden !== 'undefined') {
    hidden = 'mozHidden'
    visibilityChange = 'mozvisibilitychange'
    state = 'mozVisibilityState'
  } else if (typeof document.msHidden !== 'undefined') {
    hidden = 'msHidden'
    visibilityChange = 'msvisibilitychange'
    state = 'msVisibilityState'
  } else if (typeof document.webkitHidden !== 'undefined') {
    hidden = 'webkitHidden'
    visibilityChange = 'webkitvisibilitychange'
    state = 'webkitVisibilityState'
  }

  function getCookie(name) {
    var a,
      c = new RegExp('(^| )' + name + '=([^;]*)(;|$)')
    if ((a = document.cookie.match(c))) {
      return unescape(decodeURI(a[2]))
    } else {
      return ''
    }
  }

  function setCookie(name, value, time) {
    var c = new Date()
    c.setTime(c.getTime() + Number(time) * 3600 * 1000)
    document.cookie =
      name + '=' + value + '; path=/;expires = ' + c.toGMTString()
  }

  function delCookie(name) {
    var exp = new Date()
    exp.setTime(exp.getTime() - 1)
    var cval = getCookie(name)
    if (cval != null)
      document.cookie = name + '=' + cval + ';expires=' + exp.toGMTString()
  }
  if (getCookie('danmu') == 'false') {
    $('body').append('<div id="danmu"><span>开启</span><br>弹幕</div>')
  } else {
    $('body').append('<div id="danmu"><span>关闭</span><br>弹幕</div>')
  }
  $('#danmu').on('click', function () {
    if (getCookie('danmu') == 'false') {
      if ($('#danmu span').text() == '关闭') {
        setCookie('danmu', 'false')
        $('#danmu span').text('开启')
      } else if ($('#danmu span').text() == '开启') {
        setCookie('danmu', 'true')
        $('#danmu span').text('关闭')
      }
    } else {
      if ($('#danmu span').text() == '开启') {
        setCookie('danmu', 'true')
        $('#danmu span').text('关闭')
      } else if ($('#danmu span').text() == '关闭') {
        setCookie('danmu', 'false')
        $('#danmu span').text('开启')
      }
    }
  })
  if (barrager.mode == 1) {
    var looper_time = 5 * 1000
    var run_once = true
    var visi = true
    if (document[state] == 'hidden') {
      visi = false
    }
    do_barrager()

    function do_barrager() {
      if (run_once) {
        looper = setInterval(do_barrager, looper_time)
        run_once = false
      }
      document.addEventListener(
        visibilityChange,
        function () {
          if (document[state] == 'hidden') {
            visi = false
          }
          if (document[state] == 'visible') {
            visi = true
          }
        },
        false
      )
      if (visi && getCookie('danmu') != 'false') {
        $.getJSON(
          barrager.url + '/wp-json/esw/v1/get-barrager/1/' + barrager.id,
          function (data) {
            if (data.info) {
              $('body').barrager(data)
            }
          }
        )
      }
    }
  } else if (barrager.mode == 2) {
    $.ajaxSettings.async = false
    $.getJSON(barrager.url + '/wp-json/esw/v1/get-barrager/2/' + barrager.id, function (data) {
      var looper_time = 5 * 1000
      var items = data
      var total = data.length
      var run_once = true
      var index = 0
      var visi = true
      if (document[state] == 'hidden') {
        visi = false
      }
      barrager()

      function barrager() {
        if (run_once) {
          looper = setInterval(barrager, looper_time)
          run_once = false
        }
        if (index == total) {
          clearInterval(looper)
          return false
        } else {
          document.addEventListener(
            visibilityChange,
            function () {
              if (document[state] == 'hidden') {
                visi = false
              }
              if (document[state] == 'visible') {
                visi = true
              }
            },
            false
          )
        }
        if (visi && getCookie('danmu') != 'false') {
          $('body').barrager(items[index])
          index++
        }
      }
    })
  }
}
